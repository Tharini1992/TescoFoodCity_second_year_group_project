<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Delivery Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    main { flex: 1; }
    .navbar { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .nav-link { font-weight: 600; color: #333 !important; }
    .nav-link:hover { color: #2e7d32 !important; }
    
    /* Highlight row when issue is reported */
    .table-danger td {
        background-color: #f8d7da !important;
        color: #721c24;
    }

    footer {
      background: #2e7d32;
      color: white;
      padding: 30px 20px;
    }
  </style>
</head>

<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white px-4">
  <a class="navbar-brand fw-bold text-success" href="#">
    <i class="fa-solid fa-truck-fast"></i> Delivery Dashboard
  </a>

  <div class="ms-auto">
    {% if user and user.username %}
      <div class="dropdown">
        <a href="#" class="nav-link dropdown-toggle d-flex align-items-center text-dark" 
           id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
           
          <i class="fa-solid fa-circle-user fa-lg me-2 text-success"></i>
          <span class="fw-bold">{{ user.username }}</span>
        </a>

        <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userDropdown">
          <li>
            <a class="dropdown-item" href="#">
              <i class="fa-solid fa-user me-2"></i> My Account
            </a>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <a class="dropdown-item text-danger" href="{{ url_for('logout') }}">
              <i class="fa-solid fa-right-from-bracket me-2"></i> Logout
            </a>
          </li>
        </ul>
      </div>

    {% else %}
      <a href="{{ url_for('login') }}" class="nav-link d-flex align-items-center text-dark">
        <i class="fa-solid fa-circle-user fa-lg me-2"></i>
        Login
      </a>
    {% endif %}
  </div>
</nav>

<main class="container mt-4">

  <div class="bg-white p-4 rounded shadow-sm mb-4 border-start border-5 border-success">
    <div class="d-flex align-items-center">
        <div class="me-3">
            <i class="fa-solid fa-store fa-3x text-success"></i>
        </div>
        <div>
            <h2 class="fw-bold text-dark mb-1">Welcome to Tesco Food City Delivery Dashboard</h2>
            {% if user and user.username %}
                <p class="text-muted mb-0">Hello, <strong>{{ user.username }}</strong>! You are logged in and ready to deliver.</p>
            {% else %}
                <p class="text-muted mb-0">Please log in to manage your deliveries.</p>
            {% endif %}
        </div>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">
      <h5 class="mb-0"><i class="fa-solid fa-clipboard-list"></i> Manage Delivery Orders</h5>
    </div>

    <div class="card-body">

      <div class="row g-2 mb-3 align-items-end">
        <div class="col-md">
          <label class="form-label small text-muted">Order ID</label>
          <input type="text" id="orderId" class="form-control" placeholder="e.g., ORD-001">
        </div>
        <div class="col-md">
          <label class="form-label small text-muted">User Email</label>
          <input type="text" id="userEmail" class="form-control" placeholder="customer@mail.com">
        </div>
        <div class="col-md">
          <label class="form-label small text-muted">Total Amount</label>
          <input type="text" id="total" class="form-control" placeholder="e.g., $50.00">
        </div>
        <div class="col-md">
          <label class="form-label small text-muted">Status</label>
          <select id="status" class="form-select">
            <option value="Pending">Pending</option>
            <option value="In Transit">In Transit</option>
            <option value="Delivered">Delivered</option>
          </select>
        </div>
        <div class="col-md-auto">
          <button class="btn btn-success w-100" onclick="addOrder()">
            <i class="fa-solid fa-plus"></i> Add
          </button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle" id="ordersTable">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Customer</th>
              <th>Total</th>
              <th>Status</th>
              <th>Issue Note</th>
              <th style="min-width: 160px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            </tbody>
        </table>
      </div>

    </div>
  </div>
</main>

<div class="modal fade" id="issueModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="fa-solid fa-triangle-exclamation"></i> Report Delivery Issue</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="issueForm">
            <input type="hidden" id="modalOrderId"> <div class="mb-3">
                <label class="form-label fw-bold">Issue Type</label>
                <select id="issueType" class="form-select">
                    <option value="Customer Not Available">Customer Not Available</option>
                    <option value="Wrong Address">Wrong Address</option>
                    <option value="Item Damaged">Item Damaged</option>
                    <option value="Refused Delivery">Refused Delivery</option>
                    <option value="Vehicle Breakdown">Vehicle Breakdown</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Description / Notes</label>
                <textarea id="issueDescription" class="form-control" rows="3" placeholder="Describe the situation..."></textarea>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="saveIssue()">Report Issue</button>
      </div>
    </div>
  </div>
</div>

<footer>
    <div class="container text-center text-md-start">
        <div class="row">
            <div class="col-md-4 mb-3">
                <h5 class="fw-bold">Tesco Food City</h5>
                <p class="small">Crafting exceptional shopping experiences for our valued customers.</p>
            </div>
            <div class="col-md-4 mb-3">
                <h5 class="fw-bold">Contact Us</h5>
                <p class="small mb-1">üìç 380/F Leyland Junction, Panagoda</p>
                <p class="small mb-1">üìû 0763659784</p>
                <p class="small">üìß TescoFoodCity@gmail.com</p>
            </div>
            <div class="col-md-4">
                <h5 class="fw-bold">Quick Links</h5>
                <ul class="list-unstyled small">
                  <li><a href="#" class="text-white text-decoration-none">Privacy Policy</a></li>
                  <li><a href="#" class="text-white text-decoration-none">Return Policy</a></li>
                </ul>
            </div>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let currentRow = null; // Stores row currently being edited
  const issueModal = new bootstrap.Modal(document.getElementById('issueModal'));

  // --- Add Order Function ---
  function addOrder() {
    const orderId = document.getElementById("orderId").value;
    const userEmail = document.getElementById("userEmail").value;
    const total = document.getElementById("total").value;
    const status = document.getElementById("status").value;

    if (!orderId || !userEmail || !total) {
      alert("Please fill all fields!");
      return;
    }

    const table = document.getElementById("ordersTable").querySelector("tbody");
    const row = table.insertRow();
    row.setAttribute("data-id", orderId); // Store ID in row for reference

    row.innerHTML = `
      <td class="fw-bold">${orderId}</td>
      <td>${userEmail}</td>
      <td>${total}</td>
      <td>
        <span class="badge bg-${getStatusColor(status)} status-badge">${status}</span>
      </td>
      <td class="issue-text text-danger fst-italic small"></td> <td>
        <button class="btn btn-sm btn-success me-1" onclick="confirmDelivery(this)" title="Confirm Delivery">
          <i class="fa-solid fa-check"></i>
        </button>
        <button class="btn btn-sm btn-danger" onclick="openIssueModal(this)" title="Report Issue">
          <i class="fa-solid fa-triangle-exclamation"></i> Issue
        </button>
      </td>
    `;

    // Clear Inputs
    document.getElementById("orderId").value = "";
    document.getElementById("userEmail").value = "";
    document.getElementById("total").value = "";
  }

  // --- Helper for Badge Colors ---
  function getStatusColor(status) {
    if(status === 'Pending') return 'warning text-dark';
    if(status === 'In Transit') return 'info text-dark';
    if(status === 'Delivered') return 'success';
    return 'secondary';
  }

  // --- Confirm Delivery (Green Button) ---
  function confirmDelivery(btn) {
    const row = btn.closest("tr");
    const badge = row.querySelector(".status-badge");
    
    // Change status to Delivered
    badge.className = "badge bg-success status-badge";
    badge.innerText = "Delivered";
    
    // Remove red styling if it had an issue before
    row.classList.remove("table-danger");
    row.querySelector(".issue-text").innerText = ""; 
    
    btn.disabled = true; // Disable button after confirming
  }

  // --- Open Issue Modal (Red Button) ---
  function openIssueModal(btn) {
    currentRow = btn.closest("tr"); // Save reference to the row
    
    // Reset Modal Fields
    document.getElementById("issueType").value = "Customer Not Available";
    document.getElementById("issueDescription").value = "";
    
    issueModal.show();
  }

  // --- Save Issue Logic ---
  function saveIssue() {
    if (!currentRow) return;

    const issueType = document.getElementById("issueType").value;
    const note = document.getElementById("issueDescription").value;

    // 1. Highlight Row Red
    currentRow.classList.add("table-danger");

    // 2. Update Status Badge
    const badge = currentRow.querySelector(".status-badge");
    badge.className = "badge bg-danger";
    badge.innerText = "Issue Reported";

    // 3. Insert Note into Column
    const issueCell = currentRow.querySelector(".issue-text");
    issueCell.innerHTML = `<strong>${issueType}</strong><br>${note}`;

    issueModal.hide();
    currentRow = null;
  }
</script>

</body>
</html>